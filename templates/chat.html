{% extends "base.html" %}

{% block title %}AI Chat - NEXO{% endblock %}

{% block content %}
<div class="chat-page">
    <div class="container">
        <h1 class="page-title">AI Chat Assistant</h1>
        
        <div class="card" x-data="chatApp()">
            <div class="chat-messages" style="height: 400px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-light); border-radius: 0.5rem;">
                <template x-for="msg in messages" :key="msg.id">
                    <div :class="'message-' + msg.role" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 0.5rem;" :style="msg.role === 'user' ? 'background-color: var(--primary); color: white; margin-left: 20%;' : 'background-color: rgba(74, 144, 226, 0.1); margin-right: 20%;'">
                        <div x-html="msg.content"></div>
                    </div>
                </template>
            </div>
            
            <form @submit.prevent="sendMessage" class="form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="form-group">
                    <textarea 
                        x-model="userMessage" 
                        rows="3" 
                        class="form-control"
                        placeholder="Type your message here..."
                        required
                    ></textarea>
                </div>
                <button type="submit" class="btn btn-primary" :disabled="loading">
                    <span x-show="!loading">Send Message</span>
                    <span x-show="loading">Sending...</span>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function chatApp() {
    return {
        messages: [],
        userMessage: '',
        loading: false,
        async sendMessage() {
            if (!this.userMessage.trim()) return;
            
            this.messages.push({
                id: Date.now(),
                role: 'user',
                content: this.userMessage
            });
            
            const messageToSend = this.userMessage;
            this.userMessage = '';
            this.loading = true;
            
            const formData = new FormData();
            formData.append('message', messageToSend);
            formData.append('csrf_token', '{{ csrf_token }}');
            
            try {
                const res = await fetch('/chat/message', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                this.messages.push({
                    id: Date.now() + 1,
                    role: 'assistant',
                    content: data.response.replace(/\n/g, '<br>')
                });
            } catch (error) {
                this.messages.push({
                    id: Date.now() + 1,
                    role: 'assistant',
                    content: 'Error: Could not get response'
                });
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
